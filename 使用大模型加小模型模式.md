# 使用大模型加小模型模式运行项目

## 概述

本项目支持**两阶段分析模式**（大模型+小模型），可以大幅降低 API 成本（约 60-70%），同时保证关键帧的分析质量。

## 工作原理

### 阶段一：小模型快速筛选
- 使用轻量级模型（本地 Ollama 的 `llama3.2-vision`）对所有帧进行快速筛选
- 每帧生成简要描述、重要性评分和是否需要深度分析的标记

### 阶段二：大模型深度分析
- 仅对筛选出的关键帧使用大模型（如 `qwen-vl-max`）进行详细分析
- 筛选标准：重要性评分 ≥ 阈值（默认 6 分）或标记为"需要深度分析"
- 最多选择 N 帧（默认 10 帧）进行深度分析

## 前置条件

### 1. 确保 Ollama 服务运行

```bash
# 启动 Ollama 服务
ollama serve
```

### 2. 确保小模型已下载

```bash
# 下载 llama3.2-vision 模型
ollama pull llama3.2-vision
```

### 3. 检查 Ollama 服务状态

```bash
# 检查 Ollama 是否运行
curl http://localhost:11434/api/tags
```

## 配置说明

配置文件已创建在 `config/config.json`，主要配置项：

```json
{
    "two_stage_analysis": {
        "enabled": true,  // 启用两阶段分析
        "small_model": {
            "client": "ollama",  // 小模型使用本地 Ollama
            "model": "llama3.2-vision",
            "importance_threshold": 6,  // 重要性阈值
            "max_frames_for_deep_analysis": 10  // 最多深度分析帧数
        },
        "large_model": {
            "client": "openai_api",  // 大模型使用 API
            "model": "qwen-vl-max"
        }
    }
}
```

### 配置参数说明

- `importance_threshold`: 重要性阈值（0-10），评分 ≥ 此值的帧会被考虑深度分析
- `max_frames_for_deep_analysis`: 最大深度分析帧数，即使有更多帧满足条件，也最多只深度分析这么多帧

## 运行项目

### 基本用法

```bash
# 使用配置文件中的设置运行
video-analyzer video.mp4

# 指定配置文件目录
video-analyzer video.mp4 --config config

# 自定义提示词
video-analyzer video.mp4 --prompt "这个视频中发生了什么？"
```

### 命令行参数示例

```bash
# 调整重要性阈值和最大帧数
video-analyzer video.mp4 \
    --config config \
    --prompt "分析视频中的关键场景"

# 从第2阶段开始（跳过帧提取）
video-analyzer video.mp4 --start-stage 2

# 限制处理的帧数
video-analyzer video.mp4 --max-frames 20
```

## 输出说明

运行完成后，结果保存在 `output/analysis.json`，包含：

- `metadata`: 元数据信息，包括两阶段分析的配置
- `screening_results`: 所有帧的筛选结果（小模型生成）
- `frame_analyses`: 帧分析结果
  - `analyzed_by: "large_model"`: 使用大模型深度分析
  - `analyzed_by: "small_model_only"`: 仅使用小模型筛选
- `video_description`: 最终视频描述

## 成本对比

假设分析 60 帧视频：

| 方案 | 输入 Token | 输出 Token | 总成本 | 节省比例 |
|------|-----------|-----------|--------|---------|
| 单阶段（全分析） | 90,000-150,000 | 18,000 | 108,000-168,000 | - |
| 两阶段（10帧深度） | 20,000 + 6,000 | 3,000 + 18,000 | 47,000 | **约 60-70%** |

*注：使用本地 Ollama 时，小模型筛选阶段成本为 0*

## 调优建议

### 如果漏掉重要帧
- 降低 `importance_threshold`（如从 6 降到 4）
- 增加 `max_frames_for_deep_analysis`（如从 10 增加到 15）

### 如果成本仍然较高
- 降低 `max_frames_for_deep_analysis`（如从 10 降到 5）
- 提高 `importance_threshold`（如从 6 提高到 7）

### 如果筛选不准确
- 尝试使用中文能力更强的模型（如 `qwen-vl`）作为小模型
- 调整筛选 prompt（`video_analyzer/prompts/frame_analysis/frame_screening.txt`）

## 故障排除

### 问题：Ollama 连接失败
```bash
# 确认 Ollama 服务正在运行
curl http://localhost:11434/api/tags

# 如果失败，启动 Ollama
ollama serve
```

### 问题：没有帧被选中深度分析
- 检查 `importance_threshold` 是否设置过高
- 查看 `screening_results` 中的 `importance_score` 分布

### 问题：筛选结果解析失败
- 检查 `frame_screening.txt` prompt 格式是否正确
- 查看 `screening_results` 中的 `raw_response` 字段

## 测试配置

运行测试脚本验证配置：

```bash
python test_two_stage.py
```

## 相关文档

- [两阶段分析详细文档](docs/TWO_STAGE_ANALYSIS.md)
- [使用指南](docs/USAGES.md)
- [设计文档](docs/DESIGN.md)





